version: '3.3'

services:
    database:
        image: postgres:alpine
        container_name: database
        restart: always
        ports:
            - "${DB_PORT:-5432}:5432"
        environment:
            POSTGRES_USER: "${DB_USERNAME:-postgres}"
            POSTGRES_PASSWORD: "${DB_PASSWORD:-postgres}"
            POSTGRES_DB: "${DB_DATABASE:-postgres}"
        volumes:
            - ./storage/docker/postgres:/var/lib/postgresql/data

    redis:
        image: redis:alpine
        container_name: redis
        restart: always
        ports:
            - "${REDIS_PORT:-6379}:6379"
        command: redis-server --save 60 1
        volumes:
            - ./storage/docker/redis:/data

    redis-commander:
        image: rediscommander/redis-commander:latest
        environment:
            - REDIS_HOSTS=local:redis:6379:0,local:redis:6379:1
            - HTTP_USER=
            - HTTP_PASSWORD=
        ports:
            - 8081:8081
        depends_on:
            - redis

    elastic:
        image: elasticsearch:8.12.1
        container_name: elastic
        restart: always
        environment:
            - xpack.security.enabled=false
            - discovery.type=single-node
        ports:
            - "${ELASTIC_PORT:-9200}:9200"
        volumes:
            - ./storage/docker/elastic:/usr/share/elasticsearch/data
        ulimits:
            memlock:
                soft: -1
                hard: -1

    kibana:
        image: kibana:8.12.1
        container_name: kibana
        restart: always
        environment:
            - ELASTICSEARCH_HOSTS=http://elastic:9200
        ports:
            - "${KIBANA_PORT:-5601}:5601"
        volumes:
            - ./storage/docker/kibana:/usr/share/kibana/data
        depends_on:
            - elastic

    rabbitmq:
        image: rabbitmq:3-management-alpine
        container_name: rabbitmq
        restart: always
        ports:
            - "${RABBITMQ_PORT:-5672}:5672"
            - "${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
        environment:
            RABBITMQ_DEFAULT_USER: "${RABBITMQ_USERNAME:-guest}"
            RABBITMQ_DEFAULT_PASS: "${RABBITMQ_PASSWORD:-guest}"
        volumes:
            - ./storage/docker/rabbitmq:/var/lib/rabbitmq

    frontend:
        image: node:18-alpine
        container_name: frontend
        restart: always
        ports:
            - "5173:5173"
        working_dir: /app
        command: npm run dev -- --host
        volumes:
            - ./:/app
